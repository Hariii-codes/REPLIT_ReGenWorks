{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <a href="{{ url_for('infrastructure_project_detail', project_id=project.id) }}" class="btn btn-outline-secondary mb-3">
                <i class="fas fa-arrow-left me-1"></i>Back to Project
            </a>
            <h1 class="mb-3">
                <i class="fas fa-link me-2"></i>
                Blockchain: {{ project.project_name }}
            </h1>
            <p class="text-muted">Complete immutable ledger of material flow from waste collection to infrastructure</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card bg-dark">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cube me-2"></i>Blockchain Ledger</h5>
                </div>
                <div class="card-body">
                    {% if blockchain %}
                    <div class="blockchain-visualization">
                        {% for block in blockchain %}
                        <div class="blockchain-block mb-4 p-4 {% if block.is_valid %}bg-success bg-opacity-10 border-success{% else %}bg-danger bg-opacity-10 border-danger{% endif %}" 
                             style="border: 2px solid; border-radius: 8px; position: relative;">
                            
                            <!-- Block Header -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="mb-0">
                                        <i class="fas fa-cube me-2"></i>Block #{{ block.block_number }}
                                        <span class="badge {% if block.is_valid %}bg-success{% else %}bg-danger{% endif %} ms-2">
                                            {% if block.is_valid %}✓ Valid{% else %}✗ Invalid{% endif %}
                                        </span>
                                    </h6>
                                </div>
                                <small class="text-muted">{{ block.timestamp[:19] if block.timestamp else 'N/A' }}</small>
                            </div>
                            
                            <!-- Block Content -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <strong><i class="fas fa-tag me-2"></i>Action:</strong>
                                        <span class="badge bg-info ms-2">{{ block.action }}</span>
                                    </div>
                                    {% if block.batch_id %}
                                    <div class="mb-3">
                                        <strong><i class="fas fa-box me-2"></i>Batch ID:</strong>
                                        <code class="text-info ms-2">{{ block.batch_id }}</code>
                                    </div>
                                    {% endif %}
                                    <div class="mb-3">
                                        <strong><i class="fas fa-user-check me-2"></i>Verified By:</strong>
                                        <span class="text-muted ms-2">{{ block.verified_by }}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <strong><i class="fas fa-fingerprint me-2"></i>Block Hash:</strong>
                                        <div class="mt-1">
                                            <code class="small text-break d-block bg-dark p-2 rounded">{{ block.block_hash }}</code>
                                        </div>
                                    </div>
                                    {% if block.previous_hash %}
                                    <div class="mb-3">
                                        <strong><i class="fas fa-link me-2"></i>Previous Hash:</strong>
                                        <div class="mt-1">
                                            <code class="small text-break d-block bg-dark p-2 rounded">{{ block.previous_hash }}</code>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="mb-3">
                                        <strong><i class="fas fa-seedling me-2"></i>Genesis Block</strong>
                                        <span class="badge bg-primary ms-2">First Block</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Block Data -->
                            {% if block.data %}
                            <div class="mt-3 pt-3 border-top">
                                <strong><i class="fas fa-database me-2"></i>Block Data:</strong>
                                <pre class="bg-dark p-3 rounded mt-2 small text-light">{{ block.data | tojson(indent=2) }}</pre>
                            </div>
                            {% endif %}
                            
                            <!-- Chain Connector -->
                            {% if not loop.last %}
                            <div class="text-center my-2">
                                <i class="fas fa-arrow-down fa-2x text-primary"></i>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No blockchain entries yet. Material tracking will appear here once batches are linked to this project.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.blockchain-block {
    transition: transform 0.2s;
}
.blockchain-block:hover {
    transform: translateX(5px);
}
</style>
{% endblock %}

